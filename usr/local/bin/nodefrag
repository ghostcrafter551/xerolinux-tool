#!/bin/bash
set -e
##################################################################################################################
# Author	:	DarkXero
# Website	:	https://xerolinux.github.io
##################################################################################################################

# Based on Garuda Hotfixes by @TNE https://gitlab.com/garuda-linux/packages/stable-pkgbuilds/garuda-hotfixes/-/blob/master/garuda-hotfixes

echo "############################################################################################################"
echo "#####################          Applying The BTRFS noautodefrag Hotfix                  #####################"
echo "############################################################################################################"
echo
sleep 3
sudo cp /etc/fstab /etc/fstab.xero-backup
    gawk -i inplace '
/^[^#].*/ {
    if ($3 == "btrfs") {
        if (gsub(/,autodefrag/, ",noautodefrag", $4) > 0) {
            print $0" #Modified_by_xerolinux-hotfixes(1)"
            next
        }
    }
}
1
' /etc/fstab
echo
echo "############################################################################################################"
echo "#####################           REBOOTING FOR CHANGES TO TAKE EFFECT                   #####################"
echo "############################################################################################################"
sleep 3
reboot
